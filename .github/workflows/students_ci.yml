name: Tests

on:
  pull_request:
  push:
    branches:
      # GitHub cache is scoped to the branch + default branch,
      # This is not a problem for tasks, because those are usually done in one branch
      # We need to cache tools we use on push to the default branch
      # Otherwise, it CI takes too long to run
      # See https://github.com/orgs/community/discussions/27059#discussioncomment-3254477
      - master
      - main

env:
  CARGO_TERM_COLOR: always
  IS_FORK: ${{ github.repository_owner != 'instrumentisto' && 'true' || 'false }}
  IS_PR: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}

jobs:
  cache_tools:
    if: ${{ env.IS_FORK == 'true' && env.IS_PR == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/install-student-ci-deps
        name: Cache dependencies

  changed_crates:
    if: ${{ env.IS_FORK == 'true' && env.IS_PR == 'true' }}
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.crates.outputs.has_changes }}
      crates: ${{ steps.crates.outputs.crates }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # Fetch all history so that git diff can compare against any commit
          fetch-depth: 0

      - uses: ./.github/actions/install-student-ci-deps
        name: Get dependencies

      - name: Find changed crates
        id: crates
        run: |
          set -e

          crates="[]"
          for path in $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}); do
            directory=$(dirname "$path")
            cargo_toml=$(sh -c "cd ${directory} && cargo locate-project --message-format plain || true")

            if [[ -n "$cargo_toml" ]]; then
              # If this TOML file does not represent a workspace (does not have the `workspace` key)
              if ! toml get "$cargo_toml" "workspace" >/dev/null 2>&1; then
                crate=$(toml get "$cargo_toml" "package.name")
                crates=$(echo $crates | xq -c ". + ["$crate"]")
              fi
            fi
          done

          echo "crates=$crates" >> $GITHUB_OUTPUT

          if [[ "$crates" == "[]" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi


  test:
    needs: changed_crates
    if: ${{ needs.changed_crates.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        crate: ${{ fromJson(needs.changed_crates.outputs.crates) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Rust
        id: rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      # Cache dependencies by the crate name and the Rust version
      # It does not save/fetch cache from different crates, because `cargo test -p` does not build them
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.crate }}-${{ steps.rust.outputs.rustc_hash }}

      - name: Run tests on ${{ matrix.crate }}
        run: cargo test -p ${{ matrix.crate }}
